

struct NilTracker
	linkage:cpp_part nil
	|uint| 				IfDepth
	|uint| 				MsgCount
	|scfunction--|		fn
	|message--|			IfMsg
	|message--[1024]|	Items
	
	function Enter (|uint|)
		.ifdepth++
		return .MsgCount
	
	function Leave (|uint| s)
		.MsgCount = s
		.IfDepth--
		
	function SetNilness (|message| m, |scdecl| d, |nilstate| s)
		opt norefcounts
		if d.nilused > 3 // what?
		if !.MsgCount
			m.Indent = d.NilUsed
			return

		if (.MsgCount < 1024) 
			m.Indent = d.NilUsed
			.items[.MsgCount++] = m
			return

		error (m, "Too many variables")

	function Start (|scfunction| f)
		opt norefcounts
		scfunction.currfunc = f
		.fn = f
		.ifmsg = nil
		.MsgCount = 0
		for d in .fn.args				// no need add prms.... only log changes
			d.RestoreNil


	iterator
		|| n = 0
		while (n < .MsgCount++)
			yield self[n]
	


function SCDecl.RestoreNil
	.nilused = .nildeclared


function SCDecl.NilTake (|scdecl| d)
	opt norefcounts
	|| n = d.NilDeclared
	.NilUsed = n
	.NilDeclared = n
	
	
function SCDecl.NilTighten (|scfunction| f)
	opt norefcounts
	|| u = .nilused
	|| d = .NilDeclared
	if (u xor d) & nilstate.Either
		if d isnt stated
			|| p = .NilParamPos
			if u isnt Nilish
				f[p] = .MakeReal
			  else
				f[p] = .MakeOptional
