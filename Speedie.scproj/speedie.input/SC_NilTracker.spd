

datatype NilTrackerInt (uint)

struct NilTracker
	linkage:cpp_part nil
	|uint| 				MsgCount
	|message--|			IfMsg
	|message--[1024]|	Items
	
	function Using (|NilTrackerInt|)
		rz = .MsgCount++
		.items[rz] = nil
	
	function Used (|NilTrackerInt| s)
		.MsgCount = s
		
	function SetNilness (|message| m, |scdecl| d, |nilstate| s)
		opt norefcounts
		if d.nilused > 3 // what?
		if !.MsgCount
			m.Indent = d.NilUsed
			return

		if (.MsgCount < 1024) 
			m.Indent = d.NilUsed
			.items[.MsgCount++] = m
			return

		error (m, "Too many variables")

	function Start (|scfunction| f)
		opt norefcounts
		scfunction.currfunc = f
		.ifmsg = nil
		.MsgCount = 0
		for d in scfunction.currfunc.args				// no need add prms.... only log changes
			d.RestoreNil
	
	function TightenNilness (|scfunction| f)
		opt norefcounts
		for (d in f.args) (i)
			|| d2 = d.NilTighten
				f.args[i] = d2
		|| r = f.ReturnType.NilTighten
			f.ReturnType = r

	function SCDecl.NilTighten (|scdecl|)
		require self
		|| u = .nilused	
		|| d = .NilDeclared	
		.nilused = d
		if (u is stated) and (d isnt stated)
			if u isnt Nilish
				return .MakeReal
			return .MakeOptional

	iterator
		|| n = 0
		while (n < .MsgCount++)
			yield self[n]
	


function SCDecl.RestoreNil
	.nilused = .nildeclared
