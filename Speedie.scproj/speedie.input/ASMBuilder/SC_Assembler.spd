

module TextAssembler
	|dictionary of uint64|			Labels
		
	
	function TextFunc (|message| msg, |bool|) // assemble a function from text
		|| fn = SCFunction.new
		fn.source = msg
		ASmState.Sh.InitAndStartfunc(fn)
		|| arg = ASMState.Sh.TextFuncSub(msg)
			compiler.exportnames[fn.exportname] = fn
		ASmState.Sh.FinishASM
		.Labels.dispose


	function TextData (|message| msg) // assemble a function from text
		// how?


	function Assemble (|message| msg)
		opt norefcounts
		for ch in msg
			if ch istmp "asm"
				.textfunc(ch)
			  elseif ch istmp "data"
				.textdata(ch)



module SpdAssembler
	|[scfunction]|				PackFuncs
	
	function InitAss
		instruction.InstructionInit
		ASMType.InitAccess
		Instruction[asm.KNSR].Const
		Instruction[asm.KNST].Const
		target ASMNightmare {
		asm.encoders[asm.KNST] = fatasm.KNST_Encoder
		asm.encoders[asm.noop] = fatasm.NOOP_Encoder
		}
		return 
		TextAssembler.Requests		?= dictionary()
		TextAssembler.RequestTable	?= array()


	syntax access (|message| m, |µFunc|)
		cpp_part AccessStr
		opt norefcounts
		|| f = compiler.XFunc(m.name, m)
			return f.ASM					#expect (m, "This function has no ASM")
						

	function GenerateASMSub (|scfunction| fn, |bool|)
		opt norefcounts
		target ASMNightmare {
		ASMState.Sh.InitAndStartFunc(fn)
		|| A = fn.SourceArg!
		ASMType.arg(ASMState.Sh, A, ASMReg())
		ASMState.Sh.FinishASM
		.Guard
		}
		return ASMState.Sh.ok


	function Guard
		opt norefcounts
		|| A = asmreg()
		target ASMNightmare {
		|| fat = (compiler.InternalFile.ast!).EROR(A,A,A,A,0)
		}
	
	
	function GenerateASM (|scfunction| fn, |bool|) // memory safe ASM reattempt
		if !fn.tableid // oof
		rz = .GenerateASMSub(fn)
		if !rz
			if ASMState.ExpandJSM
				rz = .GenerateASMSub(fn)
			check (rz) (fn, "ASM is out of memory.")

		fn.asm!.debugprint


/*
error
	"Can’t find “OperatorPlus” on struct “FatASM”."
	pos 1838
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_Branches.spd"
	severity 4
error
	"Can't get the address of this."
	pos 624
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 845
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 1003
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 1061
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 1350
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 1695
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 1953
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 2157
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 2225
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Can't get the address of this."
	pos 2280
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Not sure how to handle this."
	pos 2731
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_RefCount.spd"
	severity 4
error
	"Not sure how to handle this."
	pos 14898
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_State.spd"
	severity 4
error
	"Not sure how to handle this."
	pos 2274
	file "/usr/local/speedie/Speedie.scproj/speedie.input/ASMBuilder/SC_ASM_Tables.spd"
	severity 4
*/

