
/*
	Jeebox internals. By Theodore H. Smith...
*/


module App {
|[string]?|					_Args = nil
|string|					Usage
|message|					_Conf
|config|					_Prefs
|string?| 					_Path = nil
|file?|						_StdOut
|file?|						_stdin

inline Sleep (|float| Duration)
	.sleep(duration.date)

function Sleep (|Date| Duration=1s)
	cpp_wrapper JB_Date__Sleep
	
function TrySleep (|date| Duration=1s, |bool|)
	cpp_wrapper JB_Date__TrySleep
	
inline TrySleep (|float| Duration, |bool|)
	return .TrySleep(duration.date)
	
syntax access (|int| i, |string?|)
	opt norefcounts
	return app.args[i]

syntax access (|string| name, |string|)
	cpp_part ArgValue
	opt norefcounts
	for R in ._rawargs
		if R.argname ~= name
			rz = R.argvalue
			exit

function Option (|string| name, |bool|)
	disabled "Use app.yes()"

function Yes (|string| name, |bool|)
	opt norefcounts
	return app[name].yes
	
//operator Has (|string| name, |bool|)
//	return .yes(name)

inline No (|string| name, |bool|)
	return !.yes(name)

function Created (|date|)
	return __now__|date|
	
function TimeID (|uint64|)
	return __time_id__

function AllowInteruptCrash (assigns:|bool|)
	cpp_wrapper JB_App__CrashOnInterupt

function Crash (|string| reason="")
	opt norefcounts
	if reason
		printline reason
	.CrashLog "AboutToCrash".cstr
	-1|&byte|[] = 0
	"Crash Failed!"
	app.quit(-1)


function CrashLog (|cstring| value)
	cpp_wrapper JB_Rec__CrashLog

syntax expect (|string?| s=nil)
	inline
	.quit(s, -1)


function Options (|[string]|)
	disabled "Use .Switches()"


function Switches (|[string]|)
	opt norefcounts
	for R in ._RawArgs
		if R.ArgName
			rz <~ R


function Args (|[string]|)
	cpp_part ArgsArray
	opt norefcounts
	|| r = ._Args
	if r != nil
		return r
	r = []
	._Args = r
	for s in ._rawargs
		if s[] != '-' or s == 1
			r <~ s
	return r
			


function CrashPrint
	cpp_wrapper JB_CrashTracer


function exepath (|string|)
	cpp_wrapper JB_App__Path


function Path (|string|)
	cpp_part OrigPath
	opt norefcounts
	visible class~file
	|| p = ._Path
	if p != nil
		return p
	p = .env["OrigScriptPath"]
	if p == nil
		p = .exepath
	._Path = p
	return p


function PrintStackTrace
	visible
	cpp_name JB_PrintStackTrace
	|| str = .StackTrace
	print str


render StackTrace (|int| skip = 2)
	cpp_wrapper JB_App__StackTrace


function Restart
	.turninto(.path, ._rawargs)

function ThreadName (assigns:|string|)
	cpp_Wrapper JB_App__SetThreadName

inline AppName (|string|)
	return .apppath.name

function AppPath (|string|)
	if platform.osx
		return .path.backtoapp
	return .path

function CallPath (|stringzeroterminated|)
	cpp_wrapper JB_App__CallPath

function TurnInto (|string| s, |[string]| R=nil, |bool|)
	cpp_Wrapper JB_App__TurnInto

function ObjMemory (|int64|)
	cpp_wrapper JB_MemCount

function StringMemory (|int64|)
	cpp_wrapper JB_MemUsedString

function OtherMemory (|int64|)
	cpp_wrapper JB_MemUsedOther

function GUIMode (assigns:|bool|)
	cpp_wrapper JB_App__GUIMode
	
function Env (|dictionary of string|)
	cpp_wrapper JB_App__Env

function ChildEnv (|StringZeroTerminated| s, assigns:|?StringZeroTerminated| value, |int|)
	cpp_wrapper JB_App__SetEnv

function Input (|string|)
	cpp_Wrapper JB_App__Readline

function IsMainThread (|bool|)
	return !.IsThreadedAsLib

libinternal IsThreadedAsLib (|bool|)
	cpp_wrapper JB_LibIsThreaded
	
function ParentID (|pid_int|)
	cpp_wrapper JB_App__ParentID
	
function ID (|pid_int|)
	cpp_wrapper JB_App__ID

function sp_run  (|&cstring| args, |int| mode = 3, |errorint|)
	cpp_Wrapper JB_SP_Run

function _RawArgs  (|array of string|)
	cpp_wrapper JB_App__Args

function exit (|int| Code=0)
	disabled "Use app.quit instead (to avoid confusion with the 'exit' statement, which exits loops!)"


function Quit (|string?| Err = nil, |int| Code=0)
	cpp_wrapper JB_App__Quit

function ErrorNumber (|&byte|)
	cpp_wrapper JB_App__ErrorNumber


function Name (|string|)
	disabled ".Filename (terminal) or .appname (gui package osx)"


inline FileName (|string|)
	return .Path.Name


function StdIn (|File!|)
	opt norefcounts
	return ._Stdin init File.newpipe(filedes.stdin)


function StdOut (|file!|)
	opt norefcounts
	return ._StdOut init file.NewPipe(filedes.stdout)

//function StdOut (|faststring!|)
// this wouldn't self-flush. and speedie isnt threaded.
// Flush on exit... suffers crashes and delays. No, basically.


function CWD (|string|)
	cpp_wrapper JB_File__CWD


function CWD (assigns:|string|, |ErrorInt|)
	return ._chdir(Value.AbsolutePath)


libinternal _chdir (|string| path, |ErrorInt|)
	cpp_wrapper JB_File__chdir


target debug
	function SetASMBreak (|bool| b)
		cpp_wrapper JB_App__SetASMBreak


render MemoryUsage (|int| Over=0)
	|[message]| items
	
	for cls in classdata.First_
		|| Mem = cls.MemoryUsed
		if mem > over
			|| s = message(@str, cls.name.wrap)
			s.Position = mem
			items <~ s
	
	items.sort

	fs <~ "\n"
	for I in items
		fs.memoryreport(i.name, i.position)
	fs <~ "\n"

	fs.memoryreport("obj",	.ObjMemory)
	fs.memoryreport("str",	.StringMemory)
	fs.memoryreport("arr",	.OtherMemory)	
	
	
libinternal FastString.MemoryReport (|string| name, |int64| Amount)
	if amount
		self <~ name
		self <~ ": "
		amount.strsize(self)
		self <~ "\n"
	

libinternal LeakMarkMemory
	cpp_wrapper JB_Mem_Mark

libinternal LeakUnMarkMemory
	cpp_wrapper JB_Mem_Unmark
	
libinternal IsQuarantined (|bool|)	
	return .path contains "/AppTranslocation/"



target !minilib {
function Say (|string| s, |bool| print=true,  |ExitCode|)
	// what if we don't want to wait. pass -1 for the timeout?
	if print
		printline s
	return "/usr/bin/say".execute([s])
	
function AppleScript (|string| str, |ExitCode|)
	return "/usr/bin/osascript".execute(["-e",str], nil)

function Sudo (|string| p, |ExitCode|)
	return .applescript("do shell script \"$p\" with administrator privileges")

function Icon (assigns:|string| path)
	|| ico = path.AbsolutePath
		.SetIcon(ico.cstr)

function SetIcon (|cstring| path)
	cpp_wrapper JB_App__SetIcon

function ShowURL (|string| path)
	cpp_part ShowURLStr
	.showurlc(path.cstr)

function ShowURLC (|cstring| path)
	cpp_wrapper JB_App__ShowURL
}


}



