
 
module CakeRun
	linkage: cpp_part Pack
	|memory|				Globals
	|message|				Code
	|message|				Clss
	|String|				Strings
	|[xfunction]|			Funcs
	|&byte|					GlobBase
	|&uint16|				GlobLink
	|&&nil|					RawFuncs
	|int|					GlobalCount
	|dictionary of &classdata| ClassTable = dictionary()
	|&classdata|			Obj
	
	function LibGlobs (|&&nil|)
		cpp_wrapper JB_App__LibGlobs

	function GlobTable (|&uint16|)
		cpp_wrapper JB_App__GlobTable
	
	function LibFuncs (|&&nil|)
		cpp_wrapper JB_App__LibFuncs

	function AddLibGlob (|?&nil| where, |string| name, |bool|)
		opt norefcounts
		expect (.GlobalCount++ < 1K) ("Too many globals")		// for detecting corrupt lib
		// wait we can't store ptrs in a dict? was this a wrapper obj?
//		.Globals.valuelower(name) = where!
		return true
		
	syntax access (|int| i, |xfunction|)
		return .Funcs[i]

	function message.Arg (|string| name, |bool| Err = false, |message|)
		opt norefcounts
		|| Ch = self[name]
			return ch
		if !err
			return message()
		.ReportFailiure(@tmp, name)
	
	
	function LoadPack (|bool|)
		.RawFuncs = .LibFuncs
		.GlobBase = .LibGlobs|&byte|
		.GlobLink = .GlobTable
		return .GetStructure and  .LoadClasses  and  .Loadfuncs
	
	
	function GetStructure (|bool|)
		opt norefcounts
		|| pk = .InputPack
		|| app = pk.last(@arg)[@tmp, "app"]
		|| sz = app[@num]
		|| arg = sz.next(@arg)
			arg.ExpectLast
			.code = arg[@tmp, "code"][@arg]
			check (.code.hasany)      ("No functions found!")
			.strings = arg["strs"].name
			.clss = arg["clss"]
			debugger.root = arg["debug"]
		return .glob(sz)
		

	function file.Compile (|file|)
		|| args = [self, "--bake", "--quiet"]
		|| Answer = speedie.ExecuteStr(args)		// now what? now what? now what
			rz = Answer.file
			if !rz.Exists
				rz = nil
		
		
	function InputPack (|messageroot|)
		|string--| x = app.args[0]
		|| fl = x.FileThatExists("load executable")
			if fl isa "spd" or "scproj" or "uwu" or "uwuz"
				fl = fl.Compile
		if fl
			rz = fl.parse
			if !rz.expect(@tmp, "cake")
				rz = nil


	function LoadFuncs (|bool|)
		opt norefcounts

		for spd in CakeRun.code
			|| fn = xfunction(spd)
			if apptable <~ fn
				fn.LinkCpp
				fn.LinkSpd

		check  (AppTable.Funcs >= 2) ("Missing 'main'")
		return stderr.ok
		
